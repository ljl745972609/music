package com.cwnu.ttpodmusic.service;

import java.io.File;
import java.util.ArrayList;

import android.app.Service;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.media.MediaPlayer;
import android.media.MediaPlayer.OnCompletionListener;
import android.os.Environment;
import android.os.IBinder;

/**
 * Service:Android??????????? ????????????????????????????????seekBar?????????????
 * 
 * @author DELL
 * 
 */
public class MusicPlayService extends Service {

	// ???????
	private ArrayList<String> musics;
	// ??岥?????
	private MediaPlayer player;
	// ?????????SD??·??
	private File dir = null;
	// ???????????????
	private BroadcastReceiver receiver;
	// ??????????±?
	private int currentMusicIndex = 0;
	// ???λ??
	private int pausePosition;
	// ???????????????????
	private boolean isRunning;
	//????????????ж??????????????
	private boolean isStarted;

	@Override
	public void onCreate() {
		// TODO Auto-generated method stub
		super.onCreate();
		player = new MediaPlayer();
		dir = Environment
				.getExternalStoragePublicDirectory(Environment.DIRECTORY_MUSIC);
		receiver = new MyActivityReceiver();
		// ????????
		IntentFilter filter = new IntentFilter();
		// ????????????й???
		filter.addAction("CurrentMusicIndex");
		filter.addAction("PlayMusicPrevious");
		filter.addAction("PlayMusicNext");
		filter.addAction("MakeMusicPlayOrPause");
		filter.addAction("CurrentMusicPosition");
		// ??????????
		registerReceiver(receiver, filter);
		//???????????????????????????ι?
		isRunning = true;
		new UpdateProgressThread().start();
		//???????
		player.setOnCompletionListener(new OnCompletionListener() {
			
			@Override
			public void onCompletion(MediaPlayer mp) {
				// TODO Auto-generated method stub
				//?????????
				if(isStarted){
					next();
				}
				
			}
		});
	}

	@Override
	public int onStartCommand(Intent intent, int flags, int startId) {
		// TODO Auto-generated method stub
		// ???intent???洫??????????
		musics = intent.getStringArrayListExtra("musics");
		return super.onStartCommand(intent, flags, startId);
	}

	@Override
	public IBinder onBind(Intent intent) {
		// TODO Auto-generated method stub
		return null;
	}

	// ????
	public void play() {
		
		// ???ò??????
		player.reset();

		try {
			player.setDataSource(dir + "/" + musics.get(currentMusicIndex));
			// ???????
			player.prepare();
			// ????????λ??
			player.seekTo(pausePosition);
			// ???????
			player.start();
			isStarted = true;
			// ???????????Activity ?????????????
			Intent intent = new Intent("setImagePause");
			sendBroadcast(intent);

			// ???????Я???????????????????
			Intent intent1 = new Intent("MusicName&MusicTotalTime");
			intent1.putExtra("MusicName", musics.get(currentMusicIndex)
					.toString());
			intent1.putExtra("MusicTotalTime", player.getDuration());
			sendBroadcast(intent1);
		} catch (Exception e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
	}

	// ???
	public void pause() {
		if (player.isPlaying()) {
			player.pause();
			// ??????????λ??
			pausePosition = player.getCurrentPosition();
			// ????????????????? ???ò?????????????
			Intent intent = new Intent("SetImgPlay");
			sendBroadcast(intent);

		}
	}

	// ?????
	public void previous() {
		currentMusicIndex--;
		if (currentMusicIndex < 0) {
			currentMusicIndex = musics.size() - 1;
		}
		pausePosition = 0;
		play();

	}

	// ?????
	public void next() {
		currentMusicIndex++;
		if (currentMusicIndex > musics.size() - 1) {
			currentMusicIndex = 0;
		}
		pausePosition = 0;
		play();
	}

	// ????????????????Activity?????????
	class MyActivityReceiver extends BroadcastReceiver {

		@Override
		public void onReceive(Context context, Intent intent) {
			// TODO Auto-generated method stub
			// ?????(???????й??????????????????)
			String action = intent.getAction();
			if ("CurrentMusicIndex".equals(action)) {
				// ???Я??????????±? ??????????0???
				currentMusicIndex = intent.getIntExtra("position", 0);
				pausePosition = 0;
				// ???????
				play();
			} else if ("PlayMusicPrevious".equals(action)) {
				// ?????????
				previous();
			} else if ("PlayMusicNext".equals(action)) {
				// ?????????
				next();
			} else if ("MakeMusicPlayOrPause".equals(action)) {
				// ??????????????
				if (player.isPlaying()) {
					pause();
				} else {
					play();
				}
			}else if ("CurrentMusicPosition".equals(action)) {
				//???seekbar?????λ??
				int percent = intent.getIntExtra("seekbarPosition", 0);
				pausePosition = percent * player.getDuration()/100;
				//?????
				Intent intent1 = new Intent("seekToPausePosition");
				intent1.putExtra("seekPostion",pausePosition);
				sendBroadcast(intent1);
				if(player.isPlaying()){
					play();
				}else {
					pause();
				}
			}
			
		}
	}

	@Override
	public void onDestroy() {
		// TODO Auto-generated method stub
		super.onDestroy();
		// ?????????????
		unregisterReceiver(receiver);
	}

	// ?????????????????????????ε??????λ????
	class UpdateProgressThread extends Thread {
		Intent intent = new Intent("UpdateProgress");

		@Override
		public void run() {
			// TODO Auto-generated method stub
			while (isRunning) {
				if (player.isPlaying()) {
					// ?????????????ι?
					try {
						Thread.sleep(1000);
						// Я??????????????????????
						intent.putExtra("currentPosition",
								player.getCurrentPosition());
						sendBroadcast(intent);
					} catch (InterruptedException e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
				}

			}
			super.run();
		}

	}
}
